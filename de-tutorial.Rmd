---
title: "Differential Expression Tutorial"
author: "Mark Dunning"
date: '`r format(Sys.time(), "Last modified: %d %b %Y")`'
output: html_document
---

# Importing the data

The data from this experiment comprises nine paired tumor/normal colon tissues on Illumina HT12\_v3 gene expression Beadchips. These data were generated to inform a comparison of technologies for microRNA profiling. However, we will only use the mRNA data here. 


```{r echo=FALSE,message=FALSE}
library(GEOquery)
library(limma)
```


```{r cache=TRUE}
library(GEOquery)
library(limma)
url <- "ftp://ftp.ncbi.nih.gov/pub/geo/DATA/SeriesMatrix/GSE33126/"
filenm <- "GSE33126_series_matrix.txt.gz"
if(!file.exists("GSE33126_series_matrix.txt.gz")) download.file(paste(url, filenm, sep=""), destfile=filenm)
gse <- getGEO(filename=filenm)
gse
```

```{r}
head(exprs(gse))
```


******
##Q  Do the data look to be normalised?

******

```{r}
exprs(gse) <- log2(exprs(gse))
boxplot(exprs(gse),outline=FALSE)
```

Inspect the clinical variables

******
##Q What column has the information about whether is sample is a tumour or normal?
##Q How many do we have in each group?

******
```{r}
pData(gse)[1:5,1:8]
pd <- pData(gse)
View(pd)
SampleGroup <- pd$source_name_ch1
table(SampleGroup)
```

# Simple t-tests

For completeness, we note that t-statistics and corresponding p-values can be generated quickly using the `genefilter` package. 

```{r}
library(genefilter)
destats <- rowttests(exprs(gse),SampleGroup)
head(destats)
```

- Can we remember the drawbacks of this approach?

# The linear model approach

Create a design matrix. Recall that this is basically how we define which sample group each array belongs to. We can either do this by hand or using a convenient function in `limma`. 

By-hand, we would do;

```{r}
design <- matrix(nrow=18,ncol=2)
design[,1] <- c(0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1)
design[,2] <- c(1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0)
colnames(design) <- c("Normal","Tumour")
```

or a shortcut in this would use the `rep` function.

```{r}
design[,1] <- rep(c(0,1),by=9)
design[,2] <- rep(c(1,0),by=9)
```

Clearly this is both time-consuming and prone to error. Recommended is the `model.matrix` function, which understands the linear model syntax of R (i.e. using the tilde `~` symbol)

```{r}
design <- model.matrix(~0+SampleGroup)
design
colnames(design) <- c("Normal","Tumour")
```

The `lmFit` funcion is used to fit the model to the data. The output has various components, most of which you probably don't need to know about.

```{r}
fit <- lmFit(exprs(gse), design)
names(fit)
dim(fit$coefficients)
head(fit$coefficients)
```


******

##Q. What is the interpretation of the `coeff` item in the output

******


Now we define the contrast

```{r}
contrasts <- makeContrasts(Tumour - Normal, levels=design)
fit2 <- contrasts.fit(fit, contrasts)
head(fit2$coeff)
```

Finally, apply the *empirical Bayes'* step

```{r}
fit2 <- eBayes(fit2)
fit2
```

We usually get our first look at the results by using the `topTable` command

```{r}
topTable(fit2)
```

The columns are as follows;

- logFC
- AveExpr
- t
- P.Value
- adj.P.Val
- B

# Including annotation

```{r}
anno <- fData(gse)
head(anno)[,1:5]
anno <- anno[,c("Symbol","Entrez_Gene_ID","Chromosome","Cytoband")]
fit2$genes <- anno
topTable(fit2)
```

# Diagnostic checks

At this point it is useful to take stock and do some diagnostic checks

```{r}
dotchart(exprs(gse)["ILMN_1704294",])
```

```{r}
boxplot(exprs(gse)["ILMN_1704294",]~SampleGroup)
```

To find how many genes are DE we can use the `decideTests` function, which also applies multiple-test correction.

```{r}
decideTests(fit2)
table(decideTests(fit2))
```


```{r}
volcanoplot(fit2)
```

# Exporting the results

```{r}
write.fit(fit2, file = "de-results.txt",adjust="BH")
```

